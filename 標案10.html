<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>標案分箱工具 - 自動箱號版本（含回填）</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, button, input { margin: 5px 5px 5px 0; padding: 5px; }
    .top-controls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
      gap: 30px;
      width: 92%;
    }
    .label-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .label-group label {
      white-space: nowrap;
    }
    .container {
      display: flex;
      gap: 30px;
      margin-top: 20px;
      width: 92%;
    }
    .box { border: 1px solid #ccc; padding: 10px; width: 45%; min-height: 300px; }
    ul { list-style: none; padding-left: 0; }
    li { margin: 5px 0; padding: 4px; border-radius: 4px; }
    li:hover { cursor: pointer; background: #e0e0e0; }
    h3 { margin-top: 0; }
    .box-controls { margin-top: 10px; }
    #boxDetails {
      margin-top: 20px;
      border: 1px solid #aaa;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
      background: #f9f9f9;
    }
  </style>
</head>
<body>

<h2>標案分箱工具（自動編號 + 回填）</h2>

<div class="top-controls">
  <div class="label-group">
    <label for="yearSelect">選擇年度：</label>
    <select id="yearSelect"></select>
  </div>
  <div class="label-group">
    <label for="boxSelect">選擇箱號：</label>
    <select id="boxSelect"></select>
    <button id="addBoxBtn">新增箱號</button>
    <button id="delBoxBtn">刪除箱號</button>
  </div>
</div>

<div class="container">
  <div class="box">
    <h3>未分箱標案（點擊加入箱號）</h3>
    <ul id="projectList"></ul>
  </div>
  <div class="box">
    <h3>箱號內容（點擊退回未分箱）</h3>
    <ul id="boxContent"></ul>
  </div>
</div>

<div style="margin-top:20px;">
  <button id="exportBtn" style="padding:10px 15px;">匯出分箱結果</button>
  <button id="showBoxDetailsBtn" style="margin-left: 10px; padding:10px 15px;">列出箱號內容</button>
  <button id="printPreviewBtn" style="margin-left: 10px; padding:10px 15px;">列印預覽</button>
  <button id="printAllBtn" style="margin-left: 10px; padding:10px 15px;">全部列印</button>
  <button id="saveToSheetBtn" style="margin-left: 10px; padding:10px 15px; background: #2c8; color: white;">儲存到 Google Sheets</button>
</div>

<div id="boxDetails"></div>
<iframe id="printFrame" style="display:none;"></iframe>

<script>
const sheetURL = "https://opensheet.vercel.app/1LI0r1gbH0Ao2b1O6GfuwQFaje55_G4v4rqZwHpkJmD0/標案資料";
const GAS_URL = "https://script.google.com/macros/s/AKfycbzQhV652hhYri9jGTkGmu_gnLFsJ-p0Mw6rXIRhTpo4HAFSiwJGw_Hj5myHSGQy1d94/exec";
const ASSIGN_SHEET = "標案整理存檔";

const yearSelect = document.getElementById("yearSelect");
const boxSelect = document.getElementById("boxSelect");
const projectList = document.getElementById("projectList");
const boxContent = document.getElementById("boxContent");
const addBoxBtn = document.getElementById("addBoxBtn");
const delBoxBtn = document.getElementById("delBoxBtn");
const exportBtn = document.getElementById("exportBtn");
const showBoxDetailsBtn = document.getElementById("showBoxDetailsBtn");
const printPreviewBtn = document.getElementById("printPreviewBtn");
const printAllBtn = document.getElementById("printAllBtn");
const saveToSheetBtn = document.getElementById("saveToSheetBtn");
const boxDetailsDiv = document.getElementById("boxDetails");

let yearData = {};          // 年度 => [標案名稱, ...]  (未分箱的)
let boxAssignments = {};   // 箱號 => [標案名稱, ...]

async function loadSheetData() {
  try {
    // 讀取「標案資料」(原始清單)
    const res = await fetch(sheetURL);
    const raw = await res.json();

    // 擷取所有年度欄位 (符合xxxx年)
    const keys = raw.length > 0 ? Object.keys(raw[0]) : [];
    yearData = {};
    keys.forEach(key => {
      const year = key.trim();
      if (/^\d{3,}年$/.test(year)) {
        yearData[year] = [];
      }
    });

    raw.forEach(row => {
      for (const key in row) {
        const year = key.trim();
        const val = row[key];
        if (yearData[year] && val && val.trim() !== "") {
          yearData[year].push(val.trim());
        }
      }
    });

    // 預設每年三箱
    boxAssignments = {};
    Object.keys(yearData).forEach(year => {
      for (let i=1; i<=3; i++) {
        boxAssignments[`${year}-${i}`] = [];
      }
    });

    // 填充年度下拉選單
    yearSelect.innerHTML = "";
    Object.keys(yearData).forEach(year => {
      const opt = document.createElement("option");
      opt.value = year;
      opt.textContent = year;
      yearSelect.appendChild(opt);
    });
    if (yearSelect.options.length > 0) yearSelect.value = yearSelect.options[0].value;

    // 讀取分箱存檔資料，並回填boxAssignments與yearData(移除已分箱項目)
    await loadBoxAssignments();

    refreshBoxSelect();
    updateProjectList();
    updateBoxContent();

  } catch(e) {
    alert("讀取 Google Sheets 資料失敗，請檢查連線與權限。\n" + e);
    console.error(e);
  }
}

async function loadBoxAssignments() {
  // 從 Google Sheets「標案整理存檔」抓已分箱資料
  try {
    const res = await fetch(`https://opensheet.vercel.app/1LI0r1gbH0Ao2b1O6GfuwQFaje55_G4v4rqZwHpkJmD0/${encodeURIComponent(ASSIGN_SHEET)}`);
    const data = await res.json();

    // 格式假設：欄位: 箱號, 標案名稱
    // 先清空所有箱號內容
    Object.keys(boxAssignments).forEach(boxId => boxAssignments[boxId] = []);

    // 將資料填入 boxAssignments
    data.forEach(row => {
      const box = row["箱號"];
      const project = row["標案名稱"];
      if (box && project && boxAssignments.hasOwnProperty(box)) {
        boxAssignments[box].push(project.trim());
      }
    });

    // 移除 yearData 中已被分配到箱號的標案 (避免重複)
    Object.keys(yearData).forEach(year => {
      const assignedProjects = [];
      Object.keys(boxAssignments).forEach(boxId => {
        if (boxId.startsWith(year + "-")) {
          assignedProjects.push(...boxAssignments[boxId]);
        }
      });
      yearData[year] = yearData[year].filter(p => !assignedProjects.includes(p));
    });

  } catch(e) {
    console.warn("讀取分箱存檔資料失敗，將使用空白分箱資料。", e);
  }
}

function refreshBoxSelect() {
  const year = yearSelect.value;
  boxSelect.innerHTML = "";
  const boxes = Object.keys(boxAssignments)
    .filter(b => b.startsWith(year + "-"))
    .sort((a,b) => {
      const nA = parseInt(a.split("-")[1]);
      const nB = parseInt(b.split("-")[1]);
      return nA - nB;
    });
  boxes.forEach(boxId => {
    const opt = document.createElement("option");
    opt.value = boxId;
    opt.textContent = boxId;
    boxSelect.appendChild(opt);
  });
  if (boxes.length > 0) boxSelect.value = boxes[0];
}

function updateProjectList() {
  const year = yearSelect.value;
  projectList.innerHTML = "";
  const projects = yearData[year] || [];
  projects.forEach(p => {
    const li = document.createElement("li");
    li.textContent = p;
    projectList.appendChild(li);
  });
}

function updateBoxContent() {
  const box = boxSelect.value;
  boxContent.innerHTML = "";
  const projects = boxAssignments[box] || [];
  projects.forEach(p => {
    const li = document.createElement("li");
    li.textContent = p;
    boxContent.appendChild(li);
  });
}

projectList.addEventListener("click", e => {
  if (e.target.tagName === "LI") {
    const project = e.target.textContent;
    const year = yearSelect.value;
    const box = boxSelect.value;
    // 移除未分箱
    yearData[year] = yearData[year].filter(p => p !== project);
    // 加入箱號
    if (!boxAssignments[box]) boxAssignments[box] = [];
    boxAssignments[box].push(project);
    updateProjectList();
    updateBoxContent();
  }
});

boxContent.addEventListener("click", e => {
  if (e.target.tagName === "LI") {
    const project = e.target.textContent;
    const year = yearSelect.value;
    const box = boxSelect.value;
    // 從箱號移除
    boxAssignments[box] = boxAssignments[box].filter(p => p !== project);
    // 加回未分箱
    if (!yearData[year]) yearData[year] = [];
    yearData[year].push(project);
    updateProjectList();
    updateBoxContent();
  }
});

yearSelect.addEventListener("change", () => {
  refreshBoxSelect();
  updateProjectList();
  updateBoxContent();
  boxDetailsDiv.textContent = "";
});

boxSelect.addEventListener("change", () => {
  updateBoxContent();
  boxDetailsDiv.textContent = "";
});

addBoxBtn.addEventListener("click", () => {
  const year = yearSelect.value;
  const boxesForYear = Object.keys(boxAssignments)
    .filter(b => b.startsWith(year + "-"))
    .map(b => parseInt(b.split("-")[1]))
    .filter(n => !isNaN(n));
  const nextNum = boxesForYear.length > 0 ? Math.max(...boxesForYear) + 1 : 1;
  const boxId = `${year}-${nextNum}`;
  boxAssignments[boxId] = [];
  refreshBoxSelect();
  boxSelect.value = boxId;
  updateBoxContent();
});

delBoxBtn.addEventListener("click", () => {
  const year = yearSelect.value;
  let boxesForYear = Object.keys(boxAssignments)
    .filter(b => b.startsWith(year + "-"))
    .map(b => ({
      id: b,
      num: parseInt(b.split("-")[1])
    }))
    .filter(b => !isNaN(b.num))
    .sort((a,b) => b.num - a.num);
  if (boxesForYear.length === 0) {
    alert("目前無可刪除的箱號");
    return;
  }
  const {id: delBoxId} = boxesForYear[0];
  // 退回分箱標案至未分箱
  if (boxAssignments[delBoxId].length > 0) {
    boxAssignments[delBoxId].forEach(p => {
      yearData[year].push(p);
    });
  }
  delete boxAssignments[delBoxId];
  refreshBoxSelect();
  updateProjectList();
  updateBoxContent();
  boxDetailsDiv.textContent = "";
});

exportBtn.addEventListener("click", () => {
  let csvContent = "箱號,標案名稱\n";
  const sortedBoxes = Object.keys(boxAssignments).sort((a,b) => {
    const [yA,nA] = a.split("-");
    const [yB,nB] = b.split("-");
    if(yA !== yB) return yA.localeCompare(yB);
    return parseInt(nA) - parseInt(nB);
  });
  sortedBoxes.forEach(boxId => {
    const projects = boxAssignments[boxId];
    if (!projects || projects.length === 0) {
      csvContent += `"${boxId}",\n`;
    } else {
      projects.forEach(p => {
        csvContent += `"${boxId}","${p}"\n`;
      });
    }
  });
  const blob = new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "分箱結果.csv";
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

showBoxDetailsBtn.addEventListener("click", () => {
  const box = boxSelect.value;
  if (!box) {
    boxDetailsDiv.textContent = "請先選擇箱號";
    return;
  }
  const projects = boxAssignments[box] || [];
  if (projects.length === 0) {
    boxDetailsDiv.textContent = `箱號 ${box} 目前沒有標案內容`;
  } else {
    let text = `箱號 ${box} 標案內容:\n\n`;
    projects.forEach((p,i) => {
      text += `${i+1}. ${p}\n`;
    });
    boxDetailsDiv.textContent = text;
  }
});

printPreviewBtn.addEventListener("click", () => {
  const box = boxSelect.value;
  if (!box) {
    alert("請先選擇箱號");
    return;
  }
  printBoxes([box]);
});

printAllBtn.addEventListener("click", () => {
  const sortedBoxes = Object.keys(boxAssignments).sort((a,b) => {
    const [yA,nA] = a.split("-").map(x => isNaN(x)?x:parseInt(x));
    const [yB,nB] = b.split("-").map(x => isNaN(x)?x:parseInt(x));
    if (yA !== yB) return yA > yB ? 1 : -1;
    return nA - nB;
  });
  printBoxes(sortedBoxes);
});

function printBoxes(boxArray) {
  const today = new Date().toISOString().slice(0,10);
  let html = `
    <html><head><meta charset="UTF-8" />
    <title>列印預覽</title>
    <style>
      @page { size: A4 landscape; margin: 20mm 15mm 25mm 15mm; }
      body { font-family: "Microsoft JhengHei", sans-serif; color: #222; margin: 0; padding: 0 15mm; -webkit-print-color-adjust: exact; }
      .page { page-break-after: always; padding-bottom: 20px; border-bottom: 2px solid #bbb; box-sizing: border-box; position: relative; }
      h1 { font-size: 24pt; font-weight: 900; text-align: center; margin: 0; padding-bottom: 4px; border-bottom: 2px solid #005a9e; color: #005a9e; letter-spacing: 1.5px; }
      .date { font-size: 14pt; color: #555; text-align: center; margin: 8px 0 16px 0; font-weight: 600; }
      h3 { font-size: 18pt; font-weight: 700; color: #003f72; margin-bottom: 25px; letter-spacing: 1.5px; }
      ul { list-style-type: disc; padding-left: 50px; font-size: 17pt; line-height: 1.3; margin-top: 0; margin-bottom: 30px; word-break: break-word; }
      ul li { margin-bottom: 8px; }
      p.no-projects { font-size: 20pt; font-style: italic; color: #999; margin-bottom: 50px; text-align: center; }
    </style></head><body>
  `;
  boxArray.forEach(boxId => {
    const projects = boxAssignments[boxId];
    html += `<div class="page"><h1>苗栗縣三義鄉公所</h1><div class="date">列印日期：${today}</div><h3>箱號：${boxId}</h3>`;
    if (!projects || projects.length === 0) {
      html += `<p class="no-projects">（此箱無標案）</p>`;
    } else {
      html += `<ul>`;
      projects.forEach(p => { html += `<li>${p}</li>`; });
      html += `</ul>`;
    }
    html += `</div>`;
  });
  html += `</body></html>`;

  const frame = document.getElementById("printFrame");
  const doc = frame.contentWindow.document;
  doc.open(); doc.write(html); doc.close();
  frame.onload = () => {
    frame.contentWindow.focus();
    frame.contentWindow.print();
  };
}

saveToSheetBtn.addEventListener("click", async () => {
  try {
    // 將 boxAssignments 轉成陣列物件 [{箱號, 標案名稱}, ...]
    const payload = [];
    Object.keys(boxAssignments).forEach(boxId => {
      boxAssignments[boxId].forEach(project => {
        payload.push({ 箱號: boxId, "標案名稱": project });
      });
    });
    const res = await fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    });
    const text = await res.text();
    if (text.includes("Success")) {
      alert("✅ 分箱結果已成功儲存至 Google Sheets！");
    } else {
      alert("❌ 儲存失敗：" + text);
    }
  } catch (err) {
    alert("❌ 發送失敗：" + err.message);
  }
});

loadSheetData();
</script>
</body>
</html>
